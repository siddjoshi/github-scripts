# Malware Scanning Automation

Wrapper around [github-sbom-toolkit](https://github.com/advanced-security/github-sbom-toolkit) to scan all repositories in a GitHub Enterprise or Organization, detect malware advisories, and open/update issues in a central monitoring repository. Supports incremental scans, caching, and configurable notifications.

## Prerequisites
- Node.js 20+
- Python 3.11+
- GitHub token with access to target repos:
  - `repo`, `read:packages`, `security_events`
  - `read:org` (org) or enterprise-wide token (enterprise)
  - `issues:write` on the central monitoring repository
- github-sbom-toolkit (installed via npm or npx)

## Configuration
Copy `config.yaml.example` to `config.yaml` and adjust:
- `scope.type`: `enterprise` or `organization`
- `scope.name`: enterprise slug or org login
- `central_repo`: owner/name where issues will be filed
- `notifications`: users/teams to mention
- `issue_labels`: labels applied to created issues
- `scan_settings`: toolkit options and cache directories
- `performance`: incremental scan, max_workers, cache TTL, state DB path

Example snippet:
```
scope:
  type: enterprise
  name: my-enterprise
central_repo:
  owner: my-org
  name: security-monitoring
performance:
  incremental_scan: true
  max_workers: 10
```

## Running Locally
```
pip install -r malware-scanning/requirements.txt
npm install -g github-sbom-toolkit

GITHUB_TOKEN=ghp_xxx python malware-scanning/malware_scanner.py \
  --config malware-scanning/config.yaml \
  --scope-type enterprise \
  --scope-name my-enterprise
```

Outputs are written to `malware-scanning/run-logs/` (JSON summary). Issues are created/updated in the configured `central_repo`.

## GitHub Actions
Workflow: `.github/workflows/malware-scanning.yml`
- Triggers: daily schedule (02:00 UTC) and `workflow_dispatch`
- Inputs: `scope_type` (enterprise|organization), `scope_name`, `debug_mode`
- Secrets: `ENTERPRISE_GITHUB_TOKEN` (preferred) or `GITHUB_TOKEN`
- Optional: `vars.GITHUB_API_URL` for GHES

## Incremental & Performance Optimizations
- Change detection: skip repos with no commits since last scan (state stored in `scan_state.json`).
- SBOM & malware caches: reuse `sbom-cache` and `malware-cache` directories.
- Parallel scanning: configurable `max_workers` (default 10).
- Batch API use and minimal issue churn: only update issues when findings change; close when resolved if enabled.

## Issue Strategy
- One issue per affected repository in the central monitoring repo.
- Title: `[Malware Alert] Repository: {repo} - {count} malware package(s) found`
- Body: table of package/version/PURL/advisory and mentions for configured users/teams.
- If no findings remain, issue is closed (configurable).

## Notes
- For very large estates, consider sharding scope across multiple workflow runs (by org slice) and using distributed runners.
- Ensure Dependency Graph is enabled on target repos; otherwise SBOM collection will be skipped by the toolkit.

